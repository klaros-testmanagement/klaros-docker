ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

= Klaros Test Management Docker-Integration
:toc: macro

image:https://img.shields.io/badge/Version-4.12.3-green.svg[]
image:https://img.shields.io/badge/License-MIT-green[]
image:https://img.shields.io/badge/Community%20Edition-FREE-green[]

toc::[]

== 1. Introduction

IMPORTANT: The Apache Derby database is only supported for testing purposes. An adjustment of the configurations is described in the section "Configuring Docker Environment Variables". The database systems: MySQL, PostgreSQL and MariaDB are supported by Klaros Test Management under Docker and are ready for production. Instructions for installing Klaros Test Management with MySQL, PostgreSQL or MariaDB can be found https://github.com/klaros-testmanagement/klaros-docker/blob/master/Documentation.adoc[here.] 

Plan, control and document your entire test process with https://www.klaros-testmanagement.com/en_US/[Klaros Test Management] and integrate it seamlessly with leading tools for test automation, defect management and requirements management.

Klaros can be configured in a multitude of ways and reduces maintenance costs through reusable test procedures.

Manual and automated test cases are consolidated and evaluated collectively. Workload, progress and success of test activities can be tracked at any time.

You can checkout our demo version https://www.klaros-testmanagement.com/demo/pages/login.seam[here.]

https://www.docker.com/[Docker] is a free container-based software that allows a secure installation of applications on different operating systems such as Windows and Linux without a great deal of additional effort.

This installation documentation shows step-by-step how to install and configure Klaros Test Management under Docker for Windows and Linux.

With the download you receive the free Community Edition and you can start immediately.

The Community Edition can be used without restrictions and has a reduced range of functions.

With no limitation on the number of projects, test cases or users, it is ideal for getting started in a small team.

You can upgrade the Community Edition to the Enterprise Edition at any time by uploading a license file.

The Enterprise Edition offers you the full range of functions, including one year of support and free access to all software updates. Take a look at the Community and Enterprise Edition comparison https://www.klaros-testmanagement.com/en_US/test-management/test-management-tool-comparison[here.]

To receive your free 30-day trial license for the Enterprise Edition, you can request your license key https://www.klaros-testmanagement.com/en_US/trial[here.]

IMPORTANT: Keep in mind that data from the additional features will no longer be available after expiration.

You can find further information at https://www.docker.com/why-docker[Why-Docker] and https://www.klaros-testmanagement.com/en_US/[Klaros Test Management]

== 2. Prerequisites

.Windows
[%collapsible]
====

The current hardware requirements and installation steps are described in the https://docs.docker.com/docker-for-windows/install/[official Docker documentation.] The Docker Desktop installation requires a login.

To make it easier to update Klaros Test Management later, it is recommended to download the Dockerfile using Git from GitHub.
Git can be downloaded and installed from the https://git-scm.com[official site.]

During the installation you can select whether and how the line endings of files should be converted. Since the server is running on Linux inside the container, and the line endings differ from Windows (\r) and Linux (\n), we recommend to select the option "Checkout as-is, commit Unix-style line endings" or "Checkout as-is, commit as-is".

.Configuration of the line end conversion
image::images/ConfigurationOfTheLineEndConversion.png[Configuration of the line end conversion]

This completes the preparations for Windows. The chapter "Download the Dockerfile from Klaros Test Management via GitHub" describes how to use Git Bash to download the Dockerfile and prepare it for future updates.
====

.Linux
[%collapsible]
====

See the official Docker documentation for the latest hardware requirements and installation steps.

https://docs.docker.com/install/linux/docker-ce/ubuntu/[Ubuntu Docker]

https://docs.docker.com/install/linux/docker-ce/debian/[Debian Docker]

https://docs.docker.com/install/linux/docker-ce/centos/[CentOS Docker]

https://www.cyberciti.biz/faq/install-use-setup-docker-on-rhel7-centos7-linux/[RHEL Docker]

Under CentOS and RHEL, Podman is a popular alternative to Docker. Since Podman provides similar functions as Docker, the code sections with "docker" only need to be replaced by "podman".

Supported https://podman.io/getting-started/installation.html[Podman] version: 1.4.4

https://git-scm.com/[Git] is required to successfully download the Klaros Test Management Dockerfile from GitHub.


.Git installation via Ubuntu/Debian:
----
sudo apt-get update
sudo apt-get install git
----

.Git installation via CentOS/RHEL:
----
sudo yum check-update
sudo yum install git-core
----


The following command can be used to check whether the installation was successful:
----
git --version
Output: git version 2.20.1
----

This completes the preparations for Linux. The chapter "Installation" describes how the Dockerfile can be downloaded and prepared for future updates.
====

== 3. Configuring Docker Environment Variables

.Configurable environment variables before the first server start via the Dockerfile
[options="header,footer"]
|=======================
|Variable |Default |Description
|TOMCAT_ADMIN_PASSWORD  |P@ssw0rd  |Password for login 127.0.0.1:18080/monitoring
|TOMCAT_MEMORY_MIN           |128 |Minimum available RAM in MB
|TOMCAT_MEMORY_MAX           |768   |Maximum available RAM in MB
|JAVA_OPTS  |-Duser.timezone=  | With JAVA_OPTS additional settings can be transferred to the Tomcat server. In this example the time zone is set to empty
|KLAROS_VERSION         |${KLAROS_VERSION:-4.12.1} |Klaros version used during installation. Versions can be found on the official https://www.klaros-testmanagement.com/en_US/download[Klaros Test Management] website or on https://github.com/klaros-testmanagement/klaros-docker/releases[GitHub]
|=======================

.Modifiable variables after the first server start via the Dockerfile
[options="footer"]
|=======================
|TOMCAT_MEMORY_MAX
|TOMCAT_MEMORY_MIN
|JAVA_OPTS
|=======================

=== 3.1. Configuration via the Dockerfile

Open the Dockerfile under _~/klaros-docker/ApacheDerby_ with the preferred text editor. In the Dockerfile is a list of different ENV variables available, which can be adapted and changed as desired. See Table 1 for more information.

The image must then be recreated.

=== 3.2. Configuration at server startup

Changeable variables can be found in Table 2.
The environment variables can be changed with the -e parameter.

.Example
----
sudo docker run --name Klaros -p 18080:18080 -e TOMCAT_MEMORY_MAX='1024' -e <Other Variables> klaros
----

=== 3.3. Configuration via a file

To specify the configurations via a file, any text file can be created in the ApacheDerby directory. Modifiable variables can be found in Table 2. When creating the container, add the --env-file parameter.

.Windows Example
[%collapsible]
====
----
New-Item <Path/env-list.txt> -ItemType file
echo "TOMCAT_MEMORY_MAX=1024" > env-list.txt
sudo docker create --name Klaros -p 18080:18080 --env-file ./env-list.txt klaros
----
====

.Linux Example
[%collapsible]
====
----
touch env-list
echo "TOMCAT_MEMORY_MAX=1024" > env-list
docker create --name Klaros -p 18080:18080 --env-file ./env-list klaros
----
====

== 4. How to use an older version
Since it is not possible to switch from a newer to an older version, a new installation of Klaros has to be created in order to use an older Klaros Test Management version.

All available Klaros Test Management versions for Docker can be found under https://github.com/klaros-testmanagement/klaros-docker/releases[GitHub.] 

After the Dockerfile has been downloaded via Git together with the configurations, a version list can be listed with "git tag" and selected as local branch via "git checkout".

----
git tag
git checkout tags/<tag_name> -b klaros
----

== 5. Installation
=== 5.1. Clone
Once you are in the directory you want, you can start downloading the Dockerfile.
----
git init
git clone https://github.com/klaros-testmanagement/klaros-docker 
----

With "ls" you can check whether the directory was created correctly.
----
ls
Output: klaros-docker
----

=== 5.2. Build
The image is needed to create the Klaros container and start the server. +
Windows users are switching from Git Bash to Powershell.

----
cd ~/klaros-docker/ApacheDerby
docker build -t klaros .
----

== 6. Usage
=== 6.1. How to start an instance
For the successful start of Klaros Test Management, a Docker-Container with the name "Klaros" will be created.

IMPORTANT: An anonymous volume is created when the container is created. If a named volume is desired, then -v must be added as an additional parameter.

.One-time execution: Create a Klaros container (anonymous volume)
----
docker create --name Klaros -p 18080:18080 klaros
----

.One-time execution: Create a Klaros container (named volume)
----
docker create --name Klaros -p 18080:18080 -v klaros-data:/data klaros
----

.Once the container has been created, the server can be booted with "docker start".
----
docker start -a Klaros
----

.To execute the container in detached mode, the -a parameter must be removed.
----
docker start Klaros
----

[%collapsible]
====
You can find further information in the https://docs.docker.com/engine/reference/commandline/start/[official Docker Documentation.]

After the server has been started, the message "Server startup in x ms" appears at the end. You can now use any browser to enter your IP address and port to access the Klaros website.

----
Username: admin
Password: admin
----

Example: 127.0.0.1:18080

====

It is also possible to create a second instance of Klaros via another port with its own database.

.Create a second Klaros instance with its own database
----
docker create --name Klaros2 -p 18081:18080 klaros
----

=== 6.2. How to shut down your instance
In detached mode, the server must be shut down via "docker stop".
If the container has been started in the foreground, press CTRL + C to return to the terminal and shut down the container automatically. Windows is considered as an exception and the container must be closed via "docker stop".
----
docker stop Klaros
----

== 7. Create, restore and test a backup
Backups are labeled with the name "backup_klaros<date>.tar.gz". If you create several backups per day, it is recommended to specify a time (hours, minutes and seconds) when creating the backups. To do this, add %H(hour), %M(minute), and %S(second) in date/Get-Date.

.Windows Example
----
$(Get-Date -UFormat "%y-%m-%d-%Hh-%Mm-%Ss")
----

.Linux Example
----
$(date '+%y-%m-%d-%H:%M:%S')
----

[%collapsible]
====
This would give the backup the following name:

Windows: backup_klaros19-10-28-11h-34m-33s.tar.gz +
Linux: backup_klaros19-10-28-11:34:33.tar.gz

To change the backup path, the code section behind -v: "~/klaros-docker/backup" can be changed to any other path.

.Windows Example
----
mkdir ~/klaros-docker/Path/backup
docker run --rm --volumes-from Klaros -v ~/klaros-docker/Path/backup:/backup alpine tar cvzf /backup/backup_klaros$(Get-Date -UFormat "%y-%m-%d").tar.gz /data/klaros-home /data/catalina-base/logs
----

.Linux Example
----
mkdir ~/klaros-docker/Path/backup
sudo docker run --rm --volumes-from Klaros -v ~/klaros-docker/Path/backup:/backup alpine tar cvzf /backup/backup_klaros$(date '+%y-%m-%d').tar.gz /data/klaros-home /data/catalina-base/logs
----
====

=== 7.1. Creating a backup

.Windows
----
docker stop Klaros
mkdir ~/klaros-docker/backup
docker run --rm --volumes-from Klaros -v ~/klaros-docker/backup:/backup alpine tar cvzf /backup/backup_klaros$(Get-Date -UFormat "%y-%m-%d").tar.gz /data/klaros-home /data/catalina-base/logs
docker start -a Klaros
----

.Linux
----
sudo docker ps
sudo docker stop Klaros
sudo docker run --rm --volumes-from Klaros -v ~/klaros-docker/backup:/backup alpine tar cvzf /backup/backup_klaros$(date '+%y-%m-%d').tar.gz /data/klaros-home /data/catalina-base/logs
sudo docker start -a Klaros
----

=== 7.2. Restore a Backup

.Note to adjust the date of the respective backups.
----
docker stop Klaros
docker run --rm --volumes-from Klaros -v ~/klaros-docker/backup:/backup alpine /bin/sh -c "cd /data && tar xvzf /backup/backup_klaros19-10-28.tar.gz --strip 1"
docker start -a Klaros
----

=== 7.3. Test a Backup

To test a backup, you can create a second Klaros instance to play the backup on. The second instance must be fully booted once before the backup can be installed.

----
docker run --name Klaros-test -p 18081:18080 klaros
----

The server is then stopped with CTRL + C or with "docker stop".
----
docker stop Klaros-test
----

.Note to adjust the date of the respective backups.
----
docker run --rm --volumes-from Klaros-test -v ~/klaros-docker/backup:/backup alpine /bin/sh -c "cd /data && tar xvzf /backup/backup_klaros19-10-28.tar.gz --strip 1"
docker start -a Klaros-test
----

If the backup has been successfully tested, the server can be stopped and removed.
----
docker stop Klaros-test
docker rm -v Klaros-test
----

== 8. How and where can I find the logfiles?

It may happen that log files are required for error detection. In this case, it is possible to open a shell directly in the Docker-Container in order to read the logs in the container, or to display the logs directly from the backup.

If an error occurs while creating the backup, the log file provides useful hints.

=== 8.1. Show logs via the Docker shell
Open a shell with "docker exec" in the Klaros container to get access to the logs.

Please note that the server must be started during access via the shell and must not be shut down.

Important logs can be found at:

_/data/catalina-base/logs_
----
docker exec -it Klaros /bin/sh
----
The log files can then be read using cat or head and tail.

=== 8.2. Show logs from backup

.Windows
[%collapsible]
====
Windows users can use the https://www.winrar.de/downld.php[WinRAR] archive program to extract .tar.gz archives.

Afterwards, the Klaros Test Management logs can be displayed in the "logs" folder of catalina-base.
====

.Linux
[%collapsible]
====
To read the logs from the backup, use tar to unpack the archive.
----
sudo tar -xzf backup_klaros19-10-28.tar.gz
----

Afterwards, the Klaros Test Management logs can be displayed in the "logs" folder of catalina-base.
====

== 9. Update
IMPORTANT: If the update is only for testing purposes, do not use the original branch(klaros). Also make sure to use another volume and rebuild the old image with "docker build -t klaros ." after testing.

Before an update of Klaros Test Management should be executed, a temporary container with the volumes of Klaros must be created.

----
docker stop Klaros
docker create --name Klaros-tmp --volumes-from Klaros alpine
docker rm Klaros
----

=== 9.1. Update via master branch

Klaros can be updated to the latest version with "git pull".
----
git pull origin master
----

=== 9.2. Update via tags

To perform an update from an older to a newer version, the first step is to check for new updates in the GitHub repository. Current versions can be displayed via "git tag". Then a local branch "update" with the desired version can be created and merged. Alternatively, you can merge your local branch directly with the master instead of creating a second branch.
----
git checkout master
git pull origin master
git checkout tags/<tag_name> -b update
git checkout klaros
git merge update
git branch -D update
----

=== 9.3. Refresh image

After downloading the update from the Git repository, the next step is to remove the old image and create a new one.
----
docker rmi klaros
docker build -t klaros .
----

After the new image has been created, the server will be created with the volumes of Klaros-tmp and the temporary container will be removed. Afterwards the server can be started as usual.
----
docker create --name Klaros --volumes-from Klaros-tmp -p 18080:18080 klaros
docker rm Klaros-tmp
docker start -a Klaros
----

== 10. Uninstallation

To completely remove Klaros Test Management from Docker, the server must first be shut down and the container and volume removed.

Then remove the _~/klaros-docker_ directory and the image.
----
docker stop Klaros
docker rm -v Klaros
docker rmi klaros
rm -rf ~/klaros-docker
----

== 11. Documentation

If you are interested in our software, then you can read our https://www.klaros-testmanagement.com/files/tutorial/html/Tutorial.index.html[tutorial] or for advanced, the https://www.klaros-testmanagement.com/files/doc/html/User-Manual.index.html[user manual.]

Our installation documentation includes the installation of Klaros Test Management under Docker for Apache Derby, MySQL, PostgreSQL and MariaDB databases.

== 12. FAQ

Please take a look at our https://www.klaros-testmanagement.com/en_US/faq?inheritRedirect=true[Pricing-FAQ] and https://www.klaros-testmanagement.com/en_US/support?inheritRedirect=true[Support-FAQ] before you ask any questions.


== 13. License
Klaros Test Management for Docker is licensed under the terms of https://github.com/klaros-testmanagement/klaros-docker/blob/master/LICENSE[MIT License.]

By installing our software through Docker, you also agree to our https://www.klaros-testmanagement.com/files/current/LICENSE.txt[Limited Use Software License Agreement.]

== 14. Contact

We thank you for your attention and hope to meet the interests of many users with our documentation. We are continuously working on improving Klaros-Testmanagement.

So if you have any questions or requests or simply want to give feedback, please write to us at support@verit.de oder use our https://www.klaros-testmanagement.com/en_US/forum[User Forum.]

== 15. Acknowledgements

* https://github.com/tuxknowledge[André Raabe] for providing the https://github.com/akaer/Dockerfiles/tree/master/klaros[Apache Derby and Microsoft SQL Server Version]
